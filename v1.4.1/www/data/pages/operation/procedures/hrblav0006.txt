====== Sustitucion Blade B7xx ======

===== Datos Generales =====
 
|< 50% >|
^  Código      ^  Nombre Procedimiento         ^  Verificado                  ^  Operativo    ^  Fecha Creación  ^  Fecha Ultima Modificación  ^  Versión  ^
|  HRBLAV0006  |  Sustitucion Blade B7xx  |  @#EAFFD5:SI  |  @#EAFFD5:SI  |  23/08/2016      |  23/08/2016                 |  0.1      |

 

  * ** <fc red> IMPORTANTE: </fc> INFORMACIÓN DEL ENTORNO : ** {{popup>:documentation:cyclops:architecture?[keepOpen]|AEMET: HPC Architecture and Risk Definitions}}

===== Sistemas Objetivo =====

|< 100% 10% 10% 30% 10% 50%>| 
^  Grupo              ^  Nodos                      ^  Descripción  ^  Criticidad                        ^  Implicación                                                                  ^
|  Nodos de Computo   |  nimbus[0-9]{4}             |               |  @#EAFFD5: BAJA                    |                                                                               |


===== Sistemas Colaterales =====

|< 100% 10% 10% 30% 10% 50%>| 
^  Grupo              ^  Nodos                      ^  Descripción  ^  Criticidad                        ^  Implicación                                                                  ^
|  Nodos de Computo   |  nimbus[0-9]{4}  |               |  @#EAFFD5: BAJA                    |                                                                               |

===== Procedimiento =====

==== Descripción ====
 
  * ** PROCEDIMIENTO <fc red>__ÚNICAMENTE__</fc> PARA <fc green>ADMINISTRADORES DEL SISTEMA</fc> Y <fc orange>TÉCNICOS DE SOPORTE HARDWARE</fc> ** 
==== Alcance ====

  * ** Este procedimiento solo se ejecutara por los siguientes actores en las siguientes circunstancias: **

|< 50% >|
^  ACTOR          ^  EJECUCION                   ^  HORARIO EJECUCION                                                ^
|  AEMET          |  @#FA5858:<fc white>NO</fc>  |  NINGUNO                                                          |
|  BULL VALENCIA  |  @#FA5858:<fc white>NO</fc>  |  NINGUNO                                                          |
|  BULL AEMET     |  @#EAFFD5:SI                 |  @#EAFFD5:HORARIO ( L-J 08:00-17:30 y V 08:00-14:00 HORA LOCAL )  |
|  BULL MADRID    |  @#EAFFD5:SI                 |  @#FFFF00: INTERVENCION SOLICITADA                                |

==== Requerimientos ====

  * Para realizar el procedimiento descrito a continuación se necesitan los siguientes recursos y accesos:

    - Conexión con el sistema a través de red
    - Cliente SSH compatible con exportación de programas vía X-Windows
    - Acceso al CPD por parte del ejecutor o que los recursos (Blade) puedan ser operados físicamente por //manos remotas//
==== Ejecución ====

  * ** Se ejecutan los siguientes pasos: **

=== Conexión y Preparación ===

  - Se recomienda realizar dos conexiones al sistema:
    - Conexión ssh con el parámetro -X para permitir la ejecución de programas gráficos (( Si el cliente es windows ha de tenerse instalado un cliente ssh con esta capacidad como moabxterm ))
      * [[operation:procedures:SPXXXX0003|SPXXXX0003 : Ejecución de Firefox desde exportación X con ssh]]
      - En caso de no poder conectarse: 
        * [[operation:procedures:SPXXXX0004|SPXXXX0004 : Perdida de Conexión con la monitorización]]
    - Conexión ssh típica, pero posteriormente se crea una sesión screen:
      * [[operation:procedures:SPXXXX0002|SPXXXX0002 : Conexión SSH al Sistema]]
      * [[operation:procedures:OSADBS0007|OSADBS0007 : Creación sesión Screen]]
  - Preparación del entorno de trabajo
    - Desde la consola ssh:
      - Se ejecuta la carga del entorno de trabajo:
        * [[operation:procedures:SFCYBS0007|SFCYBS0007 : Cargar entornos de trabajo]]
      - Verificación de las variables de entorno:
        * [[operation:procedures:SFCYBS0007|SFCYBS0007 : Cargar entornos de trabajo]]

  * ** <fc orange>NOTA:</fc> ** Es posible que haya que realizar tareas físicas como la inserción y extracción de blades en el CPD, por lo que en esos casos es imprescindible tener acceso al CPD para poder realizar el procedimiento.

=== Extracción ===

  * ** <fc orange>NOTA:</fc> ** Este paso puede ser opcional si ya se ha extraído el blade a sustituir previamente por un técnico de soporte.

  * **Acciones desde consola ssh:**
  - Baja del nodo afectado y su [[:documentation:operation:terminology:mirrornode|Nodo espejo]] en el sistema
    - Cambiar el estado de la monitorizacion de los nodos: 
      * [[operation:procedures:SFCYBS0002|SFCYBS0002 : Cambiar el estado de los Nodos en Cyclops]] 
    - Cambiar el estado de slurm de los nodos: 
      * [[operation:procedures:SFSLBS0004|SFSLBS0004 : Estado de un nodo en Slurm]]
  - Apagar el nodo afectado y su [[:documentation:operation:terminology:mirrornode|Nodo espejo]]
    * [[operation:procedures:HRBLBS0003|HRBLBS0003 : Apagado Nodo]]

  * **Acciones desde interfaz web (firefox)**
  - Conectarse al chasis, contenedor de los nodos:
    * [[operation:procedures:HRCMBS0002|HRCMBS0002 : CMC B7xx Conexion interfaz web]]
  - Verificar que los nodos que corresponde al blade están apagados: 
    * [[operation:procedures:HRCMBS0003|HRCMBS0003 : CMC B7xx Verificación estado energético del nodo - interfaz web]] 
  - Poner los nodos en ** stand-by off ** : 
    * [[operation:procedures:HRCMBS0004|HRCMBS0004 : CMC Cambiar el estado energético del nodo - interfaz web]]
  - Remover los nodos : 
    * [[operation:procedures:HRCMBS0005|HRCMBS0005 : CMC Insertar/Remover un blade - interfaz web]]
  - Excluir los nodos : 
    * [[operation:procedures:HRCMBS0006|HRCMBS0006 : CMC Cambiar Exclusion nodos - interfaz web]]

  * **Acciones desde el CPD **
  - Extracción física del blade: 
    * [[operation:procedures:HRCMBS0007|HRCMBS0007 : CMC Insertar/Extraer fisicamente un blade]]

=== Inserción ===

  * ** <fc orange>NOTA:</fc> ** Este paso puede ser opcional si ya ha sido insertado el nuevo blade previamente por un técnico de soporte.

  * **Acciones desde el CPD **
  - Inserción física del blade.
    * [[operation:procedures:HRCMBS0007|HRCMBS0007 : CMC Insertar/Extraer fisicamente un blade]]

  * **Acciones desde el interfaz web (firefox) **
  - Conectarse al chasis, contenedor de los nodos:
    * [[operation:procedures:HRCMBS0002|HRCMBS0002 : CMC B7xx Conexion interfaz web]]
  - Insertar los nodos del blade
    * [[operation:procedures:HRCMBS0005|HRCMBS0005 : CMC Insertar/Remover un blade - interfaz web]]
  - Eliminar la exclusión de los nodos
    * [[operation:procedures:HRCMBS0006|HRCMBS0006 : CMC Cambiar Exclusion nodos - interfaz web]]
  - Poner los nodos en ** stand-by on **
    * [[operation:procedures:HRCMBS0004|HRCMBS0004 : CMC Cambiar el estado energético del nodo - interfaz web]]
  - Esperar entre 3~6 minutos para que el chasis tenga acceso a los nodos.
  - Actualizar la información de EEPROM correspondiente a los nodos.
    * [[operation:procedures:HRCMBS0008|HRCMBS0008 : CMC Actualizar información EEPROM de los nodos]]

=== Actualización de la información BMC ===

  * **Acciones desde el interfaz web (firefox) **
  - Se obtienen las direcciones MAC de los nodos nuevos.
    * [[operation:procedures:HRCMBS0009|HRCMBS0009 : CMC Obtener información EEPROM de los nodos]]

  * **Acciones desde consola ssh:**
  - Actualización de la clusterdb
    * [[operation:procedures:SFCBBS0005|SFCBBS0005 : Update BMC MAC Address]]
  - Extracción de la información de la bbdd para el servicio dhcp
    * [[operation:procedures:SFCBBS0002|SFCBBS0002 : Extract DHCP]]
  - Reinicio del servicio dhcp
    * [[operation:procedures:SFPMBS0009|SFPMBS0009 : Reinicio Servicio HA de Pacemaker]]

=== Configuración de la BMC ===

  * **Acciones desde consola ssh:**
  - Creación del acceso remoto a la BMC
    * [[operation:procedures:SFCYBS0008|SFCYBS0008 : TOOL: configurar Acceso remoto BMC compatibles ipmitool]]

=== Actualización Firmware de los nodos ===

  * **Acciones desde consola ssh:**
  - Verificación del estado energético de los nodos
    * [[operation:procedures:HRBLBS0005|HRBLBS0005 : Estado Energetico de un Nodo]] 
    - En caso de no estar apagados, apagar nodos:
      * [[operation:procedures:HRBLBS0003|HRBLBS0003 : Apagado Nodo]]
    - Actualizar el firmware de los nodos
      * [[operation:procedures:SFCYBS0009|SFCYBS0009 : TOOL: actualizar firmware Bull Newsca B7xx]]

=== Actualización de la información de los nodos ===

  * **Acciones desde consola ssh:**
    - Verificación del estado energético de los nodos:
      * [[operation:procedures:HRBLBS0005|HRBLBS0005 : Estado Energetico de un Nodo]]
      - En caso de no estar apagados:
        * [[operation:procedures:HRBLBS0003|HRBLBS0003 : Apagado Nodo]]
    - Obtener la información de las direcciones MAC de los nodos con la opción de Actualizar.
      * [[operation:procedures:SFCYBS0010|SFCYBS0010 : TOOL: obtención de direcciones MACs desde Log DHCP]]
    - Extracción de la información de la bbdd para el servicio dhcp
      * [[operation:procedures:SFCBBS0002|SFCBBS0002 : Extract DHCP]]
    - Reinicio del servicio dhcp
      * [[operation:procedures:SFPMBS0009|SFPMBS0009 : Reinicio Servicio HA de Pacemaker]]

=== Despliegue de imagenes ===

  * **Acciones desde consola ssh:**
    - Despliegue de imagen
      * [[operation:procedures:SFKSBS0004|SFKSBS0004 : Desplegar Imagen]]
    - Cambio de estado de monitorización de los nodos a ** diagnose **
      * [[operation:procedures:SFCYBS0002|SFCYBS0002 : Cambiar el estado de los Nodos en Cyclops]]
    - Desactivación del sistema cyclops autolink
      * [[operation:procedures:SFCYBS0011|SFCYBS0011 : TOOL: activación/desactivación del sistema autolink]]
    - Despliegue de configuraciones finales (Kconf)
      * [[operation:procedures:SFCYBS0012|SFCYBS0012 : TOOL: despliegue de configuraciones (kconf)]]

=== Actualización de Infiniband ===

  * **Acciones desde consola ssh:**
    - Actualización clusterdb
      * [[operation:procedures:HRIBBS0001|HRIBBS0001 : Actualización Infiniband (clusterdb)]]
    - NOTA: Solo en caso de fallar la actualización clusterdb, realizar la actualización manual.
      * [[operation:procedures:HRIBAV0001|HRIBAV0001 : Actualización Infiniband (flint)]]

=== Finalización, verificaciones y puesta en marcha ===

  * **Acciones desde consola ssh:**
  - Activación del sistema cyclops autolink
    * [[operation:procedures:SFCYBS0011|SFCYBS0011 : TOOL: activación/desactivación del sistema autolink]]
  - Reinicio de los nodos
    * [[operation:procedures:HRBLBS0002|HRBLBS0002 : Reinicio Nodo]]
  - Verificación de eventos bmc
    * [[operation:procedures:HRBIBS0001|HRBIBS0001 : Listar Eventos BIOS]]
    - Eliminación de eventos bmc
      * [[operation:procedures:HRBIBS0002|HRBIBS0002 : Borrar Eventos BIOS]]
  - Verificación de estado hyperthreading
    * [[operation:procedures:OSADBS0008|OSADBS0008 : Verificación estado hyperthreading]]
  - Verificación de memoria
    * [[operation:procedures:OSADBS0009|OSADBS0009 : Mostrar memoria disponible]]
  - Alta del nodo como activo en la monitorización a ** up **.
    * [[operation:procedures:SFCYBS0002|SFCYBS0002 : Cambiar el estado de los Nodos en Cyclops]]


