====== Cambio de Nodo (Blade) B7xx ======

===== Datos Generales =====
 
|< 50% >|
^  Código      ^  Nombre Procedimiento         ^  Verificado                  ^  Operativo    ^  Fecha Creación  ^  Fecha Ultima Modificación  ^  Versión  ^
|  HRBLAV0001  |  Cambio de Nodo (Blade) B7xx  |  @#EAFFD5:SI  |  @#EAFFD5:SI  |  29/07/2015      |  31/03/2016                 |  1.1      |

 

  * ** <fc red> IMPORTANTE: </fc> INFORMACION DEL ENTORNO : ** {{popup>:documentation:cyclops:architecture?[keepOpen]|AEMET: HPC Architecture and Risk Definitions}}

===== Sistemas Objetivo =====

|< 100% 10% 10% 30% 10% 50%>| 
^  Grupo              ^  Nodos                      ^  Descripción  ^  Criticidad                        ^  Implicación                                                                  ^
|  Nodos de Computo   |  nimbus[0-9]{4}             |               |  @#EAFFD5: BAJA                    |                                                                               |


===== Sistemas Colaterales =====

|< 100% 10% 10% 30% 10% 50%>| 
^  Grupo              ^  Nodos                      ^  Descripción  ^  Criticidad                        ^  Implicación                                                                  ^
|  Nodos de Computo   |  nimbus[0-9]{4}  |               |  @#EAFFD5: BAJA                    |                                                                               |

===== Procedimiento =====

==== Descripción ====
 
** <fc red>NOTA:</fc> PROCEDIMIENTO __ÚNICAMENTE__ PARA ADMINISTRADORES DEL SISTEMA ** 
==== Alcance ====

  * ** Este procedimiento solo se ejecutara por los siguientes actores en las siguientes circunstancias: **

|< 50% >|
^  ACTOR          ^  EJECUCION                   ^  HORARIO EJECUCION                                                ^
|  AEMET          |  @#FA5858:<fc white>NO</fc>  |  NINGUNO                                                          |
|  BULL VALENCIA  |  @#FA5858:<fc white>NO</fc>  |  NINGUNO                                                          |
|  BULL AEMET     |  @#EAFFD5:SI                 |  @#EAFFD5:HORARIO ( L-J 08:00-17:30 y V 08:00-14:00 HORA LOCAL )  |
|  BULL MADRID    |  @#EAFFD5:SI                 |  @#FFFF00: INTERVENCION SOLICITADA                                |

==== Ejecución ====

  * ** Se ejecutan los siguientes pasos: **

  - Conectarse externamente a un nodo de gestión: [[operation:procedures:SPXXXX0002|SPXXXX0002 : Conexión SSH al Sistema]]
    - En caso de no poder conectarse: [[operation:procedures:SPXXXX0004|SPXXXX0004 : Perdida de Conexión con la monitorización]]

=== Paso 0 - Cambio Fisico del Blade ===

<hidden Extraer Blade>
  - Apagar los nodos del blade afectado ((nodo afectado y nodo espejo)): [[operation:procedures:HRBLBS0003|HRBLBS0003 : Apagado Nodo]] ((Ej: nimbus4108, su nodo espejo es nimbus4117 (4108+9), Ej: nimbus3213, su nodo espejo nimbus3204 (3213-9), últimos dos dígitos < 9, nodo espejo es igual a la suma de 9 a los dos dígitos, si los últimos dos dígitos > 9 hay que restar 9 a estos. ))
  - Acceder al Interfaz del chasis cmc[XX] donde XX corresponde a los dos primeros dígitos de los nodos afectados:
    - Conexión ssh con la opción ** -X ** 
    - Ejecutar posteriormente el navegador //firefox//
    - Acceder por nombre al correspondiente interfaz del chasis cmc <code>http://[nombre cmc]</code> , este equivale a los dos primeros dígitos del nombre de los nodos afectados (Ej: nimbus4117, su chasis es el 41 ( nimbus[41]17 )
  - Apagar completamente los nodos afectados.
    - Poner nodos en ** stand-by-off **, ir a ** -> maintenance -> power management **
    - En el cuadro ** Server Blade ** seleccionar los nodos que componen el blade (últimos dos dígitos del hostname) y pulsar el boton ** Power Asleep **
  - Extraccion Logica de los nodos en el chasis.
    - Dirigirse en el interfaz web a la sección: ** -> maintenance -> unit change **
    - Pulsar el boton ** remove ** en en la pareja de nodos afectados.
  - Excluir nodos en el chasis
    - Excluir los nodos, ir a ** -> Hardware Exclusion **
    - Seleccionar primero un nodo y pulsar el boton ** Apply **
    - Repetir el punto anterior con el segundo nodo.
  - Localizar físicamente los nodos
    - Seleccionar los nodos, ir a ** -> identification led ** ,  correspondientes por su identificador (últimos dos dígitos del hostname)
    - Seleccionar el tiempo de duracion, Pulsar el selector ** Flash duration ** y seleccionar ** Permanent **
    - Activar el led, Pulsar el boton ** Start **
  - Dirigirse al CPD, y extraer fisicamente el blade que este apagado y con los leds (azules) parpadeando.
</hidden>
<hidden Insertar Blade>
  - Acceder al Interfaz del chasis cmc[XX] donde XX corresponde a los dos primeros dígitos de los nodos afectados:
    - Conexión ssh con la opción ** -X ** 
    - Ejecutar posteriormente el navegador //firefox//
    - Acceder por nombre al correspondiente interfaz del chasis cmc <code>http://[nombre cmc]</code> , este equivale a los dos primeros dígitos del nombre de los nodos afectados (Ej: nimbus4117, su chasis es el 41 ( nimbus[41]17 )
  - Incluir nodos en el chasis
    - Incluir los nodos, ir a ** -> Hardware Exclusion **
    - Des-seleccionar primero un nodo y pulsar el boton ** Apply **
    - Repetir el punto anterior con el segundo nodo.
    - Dirigirse en el interfaz web a la sección: ** -> maintenance -> unit change **
    - Pulsar el boton ** insert ** en los dos nodos que se han excluido previamente
    - Poner nodos en ** On** , ir a ** -> maintenance -> power management **
    - En el cuadro ** Server Blade ** seleccionar los nodos que componen el blade (últimos dos dígitos del hostname) y pulsar el boton ** On **
</hidden>

=== Paso 1 - Actualización de la clusterdb (BMC) ===

  - Obtenemos la MAC del nuevo nodo, conectadonos al interfaz web del chasis donde esta ubicado, para ello la conexion ssh se habra de haber realizado con el parametro -X para poder exportar el navegador firefox.
    - Conectados al chasis correspondiente accedemos a la seccion ** Manteinance > Blades ** Donde aparecera la lista de bmc de los nodos y sus correspondientes ** MACS ** , en caso de no aparecer pulsar el boton ** Discover All Blades ** para que actualice la tabla
      * **NOTA:** El blade no deberá estar en ningún estado "stand by XXXX" ya que el chasis no tendra acceso a la bmc y no podrá mostrar la información, entrar en la sección  
  - Actualizamos clusterdb con los datos del nuevo nodo:<code>cdbm-equipment update port hwaddr=[DIRECCION MAC BMC] --filter node=[NOMBRE BMC CORRESPONDIENTE AL NODO CAMBIADO]
</code>  
  - **IMPORTANTE**: Actualizamos DHCP en los 2  nodos gestión: [[:operation:procedures:SFCBBS0002|SFCBBS0002: Extract DHCP ]]
  - Reinicio ** dhcp **: [[:operation:procedures:SFPMBS0009|SFPMBS0009 : Reinicio Servico HA de Pacemaker ]]
  - Chequear que las bmc tienen ip, desde el chasis o en su pagina. ( por ejemplo con un ping)

=== Paso 2 - Configuración de la BMC ===

  - Se recrea la configuración bmc por defecto con la herramienta cyclops:<code>
/opt/cyclops/tools/approved/tool.configure.bmc.sh [NOMBRE NODO O RANGO DE NODOS]</code>

=== Paso 3 - Actualización de la clusterdb interfaz de Gestión ===

  - Utilizando la herramienta de cyclops:<code>
/opt/cyclops/tools/approved/tool.mac.extract.sh -n [NOMBRE NODO O RANGO DE NODOS]</code>
    * ** NOTA: ** Los nodos han de estar en estado //drain o repair// en la monitorizacion cyclops y no tener ningun job activo en ellos: [[operation:procedures:SFCYBS0002|SFCYBS0002 : Cambiar el estado de los Nodos en Cyclops]] 
<hidden Ejemplo de Salida>
<code>
[root@nimbus0 ~]# /opt/cyclops/tools/approved/tool.mac.extract.sh -n nimbus[3206,3215,4104,4113]
nimbus3206 : IN repair MODE, VALID FOR RECOVERY NODE MAC TASK
nimbus3206 : SLURM INACTIVE LAUNCH MAC RECOVERY PROCESS
nimbus3206 : ON -> RESTARTING NODE
nimbus3206 : 08:00:38:3b:3b:59
nimbus3206 : POWER OFF NODE                                                                                                                                                                  
nimbus3215 : IN drain MODE, VALID FOR RECOVERY NODE MAC TASK                                                                                                                                 
nimbus3215 : SLURM INACTIVE LAUNCH MAC RECOVERY PROCESS                                                                                                                                      
nimbus3215 : ON -> RESTARTING NODE                                                                                                                                                           
nimbus3215 : 08:00:38:3b:37:db                                                                                                                                                               
nimbus3215 : POWER OFF NODE
</code>
</hidden>

  - Con los datos obtenidos por la herramienta usar el siguiente comando de la clusterdb para actualizar la base de datos:<code>
cdbm-equipment update port hwaddr='[DIRECCION MAC OBTENIDA]' --filter 'node=[NOMBRE DE NODO] and interface=eth0'</code>
  - Volver a actualidar dhcp :[[:operation:procedures:SFCBBS0002|SFCBBS0002: Extract DHCP ]]
  - Volver a reiniciar ** dhcp **: [[:operation:procedures:SFPMBS0009|SFPMBS0009 : Reinicio Servico HA de Pacemaker ]]

=== Paso 4 - Actualización de Firmwares ===

  - Verificar que el nodo esta apagado<code>
clmctrl status [NOMBRE NODO]</code>
    - En caso de no encontrarse apagado<code>
clmctrl hardpoweroff [NOMBRE NODO]</code>
  - Comprobación de versiones firmware:<code>
/opt/BSMHW/bin/ipmitool -H [NOMBRE BMC DE NODO] -U super -P pass bulloem ver all 0
</code>
<hidden Ejemplo de Salida>
<code>
firmware version of BIOS : BIOSX03.040.02.202.04/01/2015.15:52:23
firmware version of CPLD_MAIN : 0.2.7
MC  Firmware version: 22.17.0
    Build number:     1252
    Hardware ID:      0x34
    Firmware tag:     Final Edition 20130306
    OEM:              bull
</code>
</hidden>
  - Actualización BIOS: ( //path: /etc/bfup/fw/B710/BIOS// )<code>
/opt/BSMHW/bin/ipmitool -H [NOMBRE BMC DE NODO] -U [USUARIO] -P [CLAVE] bulloem upgrade [FICHERO BIOS] BIOS 0</code>
  - Actualización CPLD_MAIN: ( //path: /etc/bfup/fw/B710/CPLD_MAIN //<code>
/opt/BSMHW/bin/ipmitool -H [NOMBRE BMC DE NODO] -U [USUARIO] -P [CLAVE] -v bulloem upgrade [FICHERO CPLD_MAIN] CPLD_MAIN 0</code>
  - Actualización CPLD_IOEXP: ( //path: /etc/bfup/fw/B710/CPLD_IOEXP //)<code>
/opt/BSMHW/bin/ipmitool -H [NOMBRE BMC DE NODO] -U [USUARIO] -P [CLAVE] -v bulloem upgrade [FICHERO CPLD_IOEXP] CPLD_IOEXP 0</code>
  - Actualizacion Tarjeta de red infiniband<code>
ibms_fw upgrade --equipment [NOMBRE NODO]</code>
  - Actualizacion de la BMC: ( //path: /etc/bfup/fw/B710/BMC //)
    - Acceder al interfaz web de la bmc, mediante una conexión ssh con la opción ** -X ** para poder ejecutar posteriormente el navegador //firefox// y acceder por nombre al correspondiente interfaz de la bmc //http://[nombre bmc]//
    - Dentro del interfaz dirigirse a: ** Maintenance > Firmware Update > BMC **
    - Seleccionar el archivo correspondiente del firmware de la BMC

  * ** NOTA: ** Para terminar, es recomendado apagar el nodo y desde el interfaz web del chasis poner este en **asleep power mode** y despues de unos segundos pasarlo a **poweron** esto forzara los cambios de la bios
  * ** NOTA: ** El firmware BIOS no tiene activado por defecto el hyperthreading, por lo que hay dos metodos para hacerlo:
<hidden Directamente entrando en la BIOS>
      - Activar el acceso directo a la bios en el proximo reinicio:<code>
/opt/BSMHW/bin/ipmitool -H [NOMBRE BMC NODO] -U super -P pass chassis bootdev bios</code>
      - Reiniciar el nodo<code>
clmctrl reset [NOMBRE DE NODO]</code>
      - Acceder a la consola del nodo<code>
conman [NOMBRE DE NODO]</code>
      - Activar HT en ** "BIOS > advanced > advanced Processor > Intel HT Technology" **
      - Pulsar **F10** y aceptar para guardar los cambios.
</hidden>
<hidden Actualizando una sección de la bios> 
      - Hacer una imagen de la bios modificada: ** OPCIONAL: ** (/opt/cyclops/aemet/updates/firmwares/bios/b710) <code>
/opt/BSMHW/bin/ipmitool -H [NOMBRE BMC NODO] -U [USUARIO] -P [CLAVE] bulloem read bios_region 0 [NOMBRE FICHERO DESTINO AREA BIOS].fd</code> 
      - Desplegar la bios con ht en otro nodo: ** OPCIONAL: ** (/opt/cyclops/aemet/updates/firmwares/bios/b710) <code>
/opt/BSMHW/bin/ipmitool -H [NONBRE BMC NODO] -U [USUARIO] -P [CLAVE] bulloem upgrade [NOMBRE FICHERO ORIGEN AREA BIOS].fd BIOS_REGION 0
</code>
</hidden>

=== Paso 5 - Despliegue de Imágenes ===

  - Localizar la imagen deseada con:<code>
ksis list</code>
<hidden Ejemplo de Salida>
<code>

  Image Name                    Status          Creation Date           Size

  cngen01v02.ref                golden          2015-11-27 10:34:20     4350320
  [compute20151014v0]           golden          2015-10-14 13:38:08     4027144
  io20151014v0                  golden          2015-10-14 13:21:45     4741926
  compute20151027v1             golden          2015-10-27 18:52:11     3945812
  login20151014v0               golden          2015-10-14 14:50:17     6901907
  devcomp.ksis                  golden          2016-02-02 14:25:34     4962608

</code>
</hidden>
  - Desplegar imagen deseada:<code>
ksis deploy [NOMBRE DE IMAGEN] [NOMBRE NODO]</code>
  - ** Opcional: ** usar la consola para seguir el estado del proceso:<code>
conman [NOMBRE NODO]</code>
  * ** NOTA: ** Al terminar el despligue el nodo puede tardar mucho en arrancar, esto puede ser debido a configuraciones como montajes NFS, ya que aun no dispone de todas las configuraciones. Se recomienda usar la consola para seguir el estado y aplicar los siguientes pasos cuando el arranque del nodo haya sido completo

=== Paso 5 - Desplegar configuraciones ===

  - ** Opcional: ** Crear certificados:<code>
kconfca --force gen -w [NOMBRE DE NODO]</code>
  - Desplegar certificados:<code>
kconfca deploy -w [NOMBRE DE NODO]</code>
  - Aplicar configuraciones:<code>
kconf apply -w [NOMBRE DE NODO]</code>
  - Actualizar configuracion de lustre:<code>
shine update -m /etc/shine/models/scratch02.lmf -n [NOMBRE DE NODO]
shine update -m /etc/shine/models/scratch01.lmf -n [NOMBRE DE NODO]</code>
  - Aplicar configuracion de lustre:<code>
shine mount -n [NOMBRE DE NODO]</code>
  - Aplicar los montajes de red nfs:<code>
ssh [NOMBRE DE NODO] mount -a</code>

=== Paso 6 - Dar de Alta el Nodo y Finalizacion ===

  - Poner el nodo en estado Diagnostico:<code>
/opt/cyclops/scripts/cyclops.sh -a diagnose -n [NOMBRE DE NODO] -c</code>
  - Verificar en la monitorizacion cyclops el estado del nodo: [[operation:monitoring:dashboard|DASHBOARD]] ( puede que sea necesario esperar a un ciclo de actualizacion ) o por comandos: [[operation:procedures:SFCYBS0001|SFCYBS0001 : Monitorizar el estado de los Nodos]]
  - Los pasos a realizar normalmente son:
    - Limpiar las entradas de la BMC (bios log), por supuesto, primero comprobar que no hay ningún fallo en ellas: [[operation:procedures:HRBIBS0001|HRBIBS0001 : Listar Eventos BIOS]]
    - Verificar el montaje de lustre: [[operation:procedures:FSLUBS0001|FSLUBS0001 : Chequeo Lustre]]
    - Verificar el estado de slurm, si todos los demás sensores están correctos realizar el siguiente comando:
      - Para el entorno de Explotacion:<code>
ssh [NODO DE GESTION] scontrol update nodename=[NOMBRE NODO] state=idle</code>
      - Para el entorno de desarrollo:<code>
ssh [NODO DE DESARROLLO] scontrol update nodename=[NOMBRE NODO] state=idle</code>
      - Si se tiene dudas sobre la pertenencia del nodo de computo usar el siguiente comando:<code>
ssh [NOMBRE NODO] sinfo -n [NOMBRE NODO]</code>
  - Verificar de nuevo el estado del nodo en la monitorizacion, 
    - En caso de estar todo correcto:<code>
/opt/cyclops/scripts/cyclops.sh -a up -n [NOMBRE DE NODO] -c</code>
    - Y cerrar la incidencia en el sistema de auditoria de cyclops:<code>
/opt/cyclops/scripts/audit.nod.sh -e info -s info -m "[CODIGO DE INCIDENCIA]: Cambio de placa, cierre incidencia" -n [NOMBRE DE NODO] -i bitacora</code>

=== ANEXO A - Comandos Vinculados ===

  - Crear una imagen de un nodo:<code>
ksis create [NOMBRE IMAGEN] [NOMBRE DE NODO]</code>